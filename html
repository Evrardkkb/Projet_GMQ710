<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Accessibilité des arrêts de bus</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body, html { margin:0; height:100%; font-family:Segoe UI, Tahoma; }

/* ======= HEADER GLOBAL ======= */
#globalHeader {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: #f4f5f6;
  color: rgb(13, 12, 12);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  font-weight: 600;
  padding: 0 20px;
  z-index: 1200;
  text-align: center;
}

/* ======= PANEL LATERAL ======= */
#panel {
  position:absolute;
  width:340px;
  height:calc(100% - 60px); 
  background:#fff;
  padding:20px;
  padding-top:30px; 
  box-shadow:2px 0 8px rgba(0,0,0,0.15);
  z-index:1000;
  overflow-y:auto;
  top:60px; /* juste sous le header global */
}

#infoIcon {
  cursor:pointer;
  font-size:18px;
  margin-left:6px;
  color:#2e54ff;
}

#map { position:absolute; left:340px; top:60px; right:0; bottom:0; }

label { display:block; margin:10px 0 5px; font-weight:600; }

input[type="number"] {
  width:100%; padding:8px;
  border:1px solid #ccc;
  border-radius:5px;
}

button {
  width:100%; padding:12px;
  background:#2e54ff; color:white;
  border:none; border-radius:7px;
  font-size:16px; cursor:pointer;
  margin-top:12px;
  display:flex; align-items:center; justify-content:center; gap:8px;
}

button:hover { background:#1b36d8; }
button:disabled { background:#9fa8ff; cursor:not-allowed; }

#loadingMessage {
  display:none;
  margin-top:10px;
  font-style:italic;
  color:#2e54ff;
  align-items:center;
  gap:10px;
}

@keyframes rotation {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#loadingMessage svg {
  animation: rotation 1.5s linear infinite;
}

.layer-item { margin:6px 0; display:flex; align-items:center; gap:6px; }

.layer-color {
  width:14px; height:14px;
  border-radius:50%;
}

#stats {
  margin-top:15px;
  font-size:0.95rem;
  border-top:1px solid #ddd;
  padding-top:10px;
}
</style>
</head>

<body>

<!-- HEADER GLOBAL -->
<div id="globalHeader">
  Analyse de l'accessibilité du transport urbain (STS) à Sherbrooke.
</div>

<!-- PANEL LATERAL -->
<div id="panel">
  <!-- h3 interne supprimé -->

  <label>Distance buffer arrêts (m)</label>
  <input type="number" id="dist" value="500" min="50" step="50" />

  <button id="btnCalculer" onclick="calculer()">
    <span id="btnText">Lancer l’analyse</span>
    <svg id="btnIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
         fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="3"
         stroke-linecap="round" stroke-linejoin="round" style="display:none;">
      <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
      <path d="M22 12a10 10 0 0 1-10 10" />
    </svg>
  </button>

  <div id="loadingMessage">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
         fill="none" viewBox="0 0 24 24" stroke="#2e54ff" stroke-width="3"
         stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
      <path d="M22 12a10 10 0 0 1-10 10" />
    </svg>
    Analyse en cours, patienter...
  </div>

  <hr>

  <h4>Couches</h4>

  <label class="layer-item">
    <input type="checkbox" id="chkArrets" checked>
    <span class="layer-color" style="background:#1e88e5"></span> Arrêts
  </label>

  <label class="layer-item">
    <input type="checkbox" id="chkLignes" checked>
    <span class="layer-color" style="background:#1565c0"></span> Lignes de bus
  </label>

  <label class="layer-item">
    <input type="checkbox" id="chkBufferLignes" checked>
    <span class="layer-color" style="background:#ff8f00"></span> Buffer lignes
  </label>

  <label class="layer-item">
    <input type="checkbox" id="chkBufferArrets" checked>
    <span class="layer-color" style="background:#7b1fa2"></span> Buffer arrêts
  </label>

  <label class="layer-item">
    <input type="checkbox" id="chkAdresses">
    <span class="layer-color" style="background:#d32f2f"></span> Adresses non desservies
  </label>

  <label class="layer-item">
    <input type="checkbox" id="chkHeat">
    <span class="layer-color" style="background:#ff6f00"></span> Heatmap
  </label>

  <hr>
  <h4>Statistiques</h4>
  <div id="stats"></div>
</div>

<div id="map"></div>

<script>
/* =======================
   FONDS DE CARTE
======================= */
const baseLayers = {
  "Fond sombre (Carto)": L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    { attribution: '© OpenStreetMap / Carto' }
  ),
  "OpenStreetMap": L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution: '© OpenStreetMap' }
  ),
  "Satellite (ESRI)": L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: '© Esri' }
  )
};

/* =======================
   CARTE (ZOOM EN HAUT DROITE)
======================= */
const map = L.map('map', {
  center: [45.4, -71.9],
  zoom: 12,
  layers: [baseLayers["Fond sombre (Carto)"]],
  zoomControl: false
});

L.control.zoom({ position: 'topright' }).addTo(map);

L.control.layers(baseLayers, null, {
  position: 'topright',
  collapsed: true
}).addTo(map);

/* =======================
   COUCHES
======================= */
const layers = {
  lignes: L.layerGroup().addTo(map),
  arrets: L.markerClusterGroup().addTo(map),
  bufferLignes: L.layerGroup().addTo(map),
  bufferArrets: L.layerGroup().addTo(map),
  adresses: L.layerGroup(),
  heat: L.layerGroup()
};

/* =======================
   DONNÉES
======================= */
fetch('/data/lignes')
  .then(r=>r.json())
  .then(d=>L.geoJSON(d,{style:{color:'#1565c0',weight:3}}).addTo(layers.lignes));

fetch('/data/arrets')
  .then(r=>r.json())
  .then(d=>L.geoJSON(d,{pointToLayer:(f,l)=>L.marker(l)}).addTo(layers.arrets));

fetch('/data/buffer_lignes')
  .then(r=>r.json())
  .then(d=>L.geoJSON(d,{style:{color:'#ff8f00',fillColor:'#ffcc80',fillOpacity:0.35}}).addTo(layers.bufferLignes));

/* =======================
   ANALYSE
======================= */
const btnCalculer = document.getElementById("btnCalculer");
const btnText = document.getElementById("btnText");
const btnIcon = document.getElementById("btnIcon");
const loadingMessage = document.getElementById("loadingMessage");

function setLoading(v){
  btnText.style.display = v ? "none" : "inline";
  btnIcon.style.display = v ? "inline-block" : "none";
  loadingMessage.style.display = v ? "flex" : "none";
  btnCalculer.disabled = v;
}

function calculer(){
  setLoading(true);
  layers.bufferArrets.clearLayers();
  layers.adresses.clearLayers();
  layers.heat.clearLayers();

  fetch('/compute_buffers',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({distance:Number(dist.value)})
  })
  .then(r=>r.json())
  .then(res=>{
    L.geoJSON(res.buffer_arrets,{style:{color:'#7b1fa2',fillColor:'#ce93d8',fillOpacity:0.45}})
      .addTo(layers.bufferArrets);

    L.geoJSON(res.adresses_non_desservies,{
      pointToLayer:(f,l)=>L.circleMarker(l,{radius:4,fillColor:'#d32f2f',color:'#b71c1c',fillOpacity:0.9})
    }).addTo(layers.adresses);

    layers.heat.addLayer(L.heatLayer(res.heat_points,{radius:25,blur:18}));

    stats.innerHTML = `
      <b>Arrêts :</b> ${res.stats.nb_arrets}<br>
      <b>Adresses totales :</b> ${res.stats.nb_adresses}<br>
      <b>Adresses desservies :</b> ${res.stats.nb_desservies}<br>
      <b>Adresses non desservies :</b> ${res.stats.nb_non_desservies}<br><br>
      <b>Pourcentage d'adresses desservies :</b> ${res.stats.pct_desservies} %
    `;
    setLoading(false);
  });
}

/* =======================
   TOGGLES
======================= */
chkArrets.onchange = e => e.target.checked ? map.addLayer(layers.arrets) : map.removeLayer(layers.arrets);
chkLignes.onchange = e => e.target.checked ? map.addLayer(layers.lignes) : map.removeLayer(layers.lignes);
chkBufferLignes.onchange = e => e.target.checked ? map.addLayer(layers.bufferLignes) : map.removeLayer(layers.bufferLignes);
chkBufferArrets.onchange = e => e.target.checked ? map.addLayer(layers.bufferArrets) : map.removeLayer(layers.bufferArrets);
chkAdresses.onchange = e => e.target.checked ? map.addLayer(layers.adresses) : map.removeLayer(layers.adresses);
chkHeat.onchange = e => e.target.checked ? map.addLayer(layers.heat) : map.removeLayer(layers.heat);
</script>

</body>
</html>
