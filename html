<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Accessibilité des arrêts de bus</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Leaflet Heatmap -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body, html {
  margin: 0;
  height: 100%;
  font-family: Arial, sans-serif;
}

#panel {
  position: absolute;
  width: 320px;
  height: 100%;
  background: white;
  padding: 15px;
  z-index: 1000;
  border-right: 1px solid #ccc;
  overflow-y: auto;
}

#map {
  position: absolute;
  left: 320px;
  right: 0;
  top: 0;
  bottom: 0;
}

button {
  width: 100%;
  padding: 8px;
  margin-top: 10px;
  font-weight: bold;
}

label {
  display: block;
  margin-top: 8px;
}

#stats {
  margin-top: 12px;
  font-size: 0.9rem;
}
</style>
</head>

<body>

<div id="panel">
  <h3>Analyse d’accessibilité</h3>

  <label>Distance buffer arrêts (m)</label>
  <input type="number" id="dist" value="500" min="50" step="50">

  <button onclick="calculer()">Calculer</button>

  <hr>

  <h4>Couches</h4>
  <label><input type="checkbox" id="chkArrets" checked> Arrêts (cluster)</label>
  <label><input type="checkbox" id="chkBufferArrets" checked> Zone desservie (arrêts)</label>
  <label><input type="checkbox" id="chkBufferLignes" checked> Zone proche des lignes</label>
  <label><input type="checkbox" id="chkAdresses"> Adresses non desservies</label>
  <label><input type="checkbox" id="chkHeat"> Heatmap zones mal desservies</label>

  <hr>
  <div id="stats"></div>
</div>

<div id="map"></div>

<script>
// ============================
// INITIALISATION DE LA CARTE
// ============================
const map = L.map('map').setView([45.4, -71.9], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// ============================
// COUCHES
// ============================
const layers = {
  lignes: L.layerGroup().addTo(map),
  bufferArrets: L.layerGroup().addTo(map),
  bufferLignes: L.layerGroup().addTo(map),
  adresses: L.layerGroup(),
  heat: L.layerGroup(),
  arretsCluster: L.markerClusterGroup({
    disableClusteringAtZoom: 16,
    showCoverageOnHover: false
  })
};

// ============================
// DONNÉES STATIQUES
// ============================

// LIGNES DE BUS
fetch('/data/lignes')
  .then(r => r.json())
  .then(data => {
    L.geoJSON(data, {
      style: { color: '#1565c0', weight: 3 }
    }).addTo(layers.lignes);
  });

// ARRÊTS (CLUSTER)
fetch('/data/arrets')
  .then(r => r.json())
  .then(data => {

    const iconBlue = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41]
    });

    const geo = L.geoJSON(data, {
      pointToLayer: (f, latlng) =>
        L.marker(latlng, { icon: iconBlue })
    });

    layers.arretsCluster.addLayer(geo);
    map.addLayer(layers.arretsCluster);
  });

// ============================
// CALCUL BACKEND
// ============================
function calculer() {

  layers.bufferArrets.clearLayers();
  layers.bufferLignes.clearLayers();
  layers.adresses.clearLayers();
  layers.heat.clearLayers();

  fetch('/compute_buffers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ distance: Number(dist.value) })
  })
  .then(r => r.json())
  .then(res => {

    // BUFFER ARRÊTS
    L.geoJSON(res.buffer_arrets, {
      style: {
        color: '#2e7d32',
        fillColor: '#81c784',
        fillOpacity: 0.4
      }
    }).addTo(layers.bufferArrets);

    // BUFFER LIGNES
    L.geoJSON(res.buffer_lignes, {
      style: {
        color: '#ff8f00',
        fillColor: '#ffcc80',
        fillOpacity: 0.35
      }
    }).addTo(layers.bufferLignes);

    // ADRESSES NON DESSERVIES
    L.geoJSON(res.adresses_non_desservies, {
      pointToLayer: (f, latlng) =>
        L.circleMarker(latlng, {
          radius: 4,
          fillColor: '#d32f2f',
          color: '#b71c1c',
          weight: 1,
          fillOpacity: 0.85
        })
    }).addTo(layers.adresses);

    // HEATMAP KDE
    const heatLayer = L.heatLayer(res.heat_points, {
      radius: 25,
      blur: 18,
      maxZoom: 17
    });

    layers.heat.addLayer(heatLayer);

    // STATS
    document.getElementById("stats").innerHTML = `
      <b>Arrêts :</b> ${res.stats.nb_arrets}<br>
      <b>Adresses desservies :</b> ${res.stats.pct_desservies}%<br>
      <b>Proches lignes :</b> ${res.stats.nb_proche_ligne}<br>
      <b>Non desservies :</b> ${res.stats.nb_non_desservies}
    `;
  });
}

// ============================
// CHECKBOXES
// ============================
document.getElementById("chkArrets").onchange = e =>
  e.target.checked
    ? map.addLayer(layers.arretsCluster)
    : map.removeLayer(layers.arretsCluster);

document.getElementById("chkBufferArrets").onchange = e =>
  e.target.checked
    ? map.addLayer(layers.bufferArrets)
    : map.removeLayer(layers.bufferArrets);

document.getElementById("chkBufferLignes").onchange = e =>
  e.target.checked
    ? map.addLayer(layers.bufferLignes)
    : map.removeLayer(layers.bufferLignes);

document.getElementById("chkAdresses").onchange = e =>
  e.target.checked
    ? map.addLayer(layers.adresses)
    : map.removeLayer(layers.adresses);

document.getElementById("chkHeat").onchange = e =>
  e.target.checked
    ? map.addLayer(layers.heat)
    : map.removeLayer(layers.heat);
</script>

</body>
</html>
